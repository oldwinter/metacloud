#https://hub.docker.com/_/ubuntu
FROM ubuntu:20.04 
LABEL OWNER="oldwinter"

WORKDIR /tmp
VOLUME [ "/data" ]

### ðŸ‘‡ðŸ»ç”¨aptåŒ…ç®¡ç†ç³»ç»Ÿï¼Œå®‰è£…ç³»ç»Ÿçº§linuxå¸¸ç”¨å·¥å…·
# apt-get å®˜æ–¹æ–‡æ¡£ï¼š https://linux.die.net/man/8/apt-get
# net-tools: netstat ifconfig
# iputils-ping: ping
# tldr: è¿…é€ŸçŸ¥é“å¦‚ä½•ä½¿ç”¨æŸå‘½ä»¤
# speedtest: æµ‹ç½‘é€Ÿ
RUN apt-get update  \
    # å–æ¶ˆæ‰€æœ‰å®‰è£…å‘½ä»¤çš„äº¤äº’,å–æ¶ˆæ‰€æœ‰æŽ¨èåŒ…çš„å®‰è£…
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        # åŒ…å«äº†ä¸€äº›æ¨¡æ¿ï¼Œå¿…è£…ï¼ŒåŽé¢å°±ä¼šè‡ªåŠ¨ç”¨æ¨¡æ¿é…ç½®è½¯ä»¶
        apt-utils \
        locales \
    # è‡ªåŠ¨è·³è¿‡å„ç§é€‰æ—¶åŒºçš„ç•Œé¢ï¼Œlocaleséœ€è¦å…ˆå®‰è£…
    && dpkg-reconfigure -f noninteractive locales \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y  --no-install-recommends \
    sudo curl git zsh \
    tree wget vim tldr \
    speedtest-cli \
    net-tools iputils-ping \
    # nodejsçš„ä¸œè¥¿ç»´æŠ¤åœ¨è‡ªå·±çš„ä»“åº“é‡Œï¼Œè¿™é‡Œå®˜æ–¹è„šæœ¬è§„å®šæ­»äº†17+ç‰ˆæœ¬ï¼Œä»¥åŽè®°å¾—æ‰‹åŠ¨æ”¹
    && curl -fsSL https://deb.nodesource.com/setup_17.x | bash - \
    && DEBIAN_FRONTEND=noninteractive  apt-get install -y --no-install-recommends  nodejs \
    # æ¸…ç†çŽ°åœºï¼Œç²¾ç®€é•œåƒlayer
    && apt-get -y autoclean \ 
    && rm -rf /var/lib/apt/lists/*

### ðŸ‘‡ðŸ»å®‰è£…npmå¸¸ç”¨å·¥å…·
# zx: ç”¨jså†™bashè„šæœ¬
# cnpmï¼Œyarn æœ‰æ—¶å¯èƒ½ä¼šç”¨åˆ°
# http-serverï¼Œå¿«é€Ÿå¯åŠ¨ä¸€ä¸ªç®€æ˜“webserveråšæµ‹è¯•ç”¨
RUN npm i -g zx cnpm yarn http-server

### ðŸ‘‡ðŸ»å®‰è£…homebrewä»¥åŠbrewä»“åº“é‡Œå¸¸ç”¨å·¥å…·
# æ·»åŠ adminç”¨æˆ·    
RUN useradd --create-home --no-log-init --shell /bin/bash admin \
    && adduser admin sudo \
    && echo 'admin:admin' | chpasswd

USER admin

# homebrewåªæ”¯æŒéžroot ç”¨æˆ·å®‰è£…
# fzf: æ‰¾æ–‡ä»¶ç¥žå™¨
# thefuckï¼šè‡ªåŠ¨çº é”™ä¸Šæ¡å‘½ä»¤å¹¶æ‰§è¡Œ 
# kubectlï¼šå…ˆè£…ä¸Šå†è¯´ï¼Œæ°¸è¿œä¼šæœ‰k8sé›†ç¾¤å¾…ä½ åŽ»è¿žæŽ¥
# kubectx: åˆ‡æ¢é›†ç¾¤å’Œnamespaceï¼Œå¤šé›†ç¾¤ç®¡ç†å¥½ç”¨å¾—é£žèµ·
RUN git clone https://github.com/Homebrew/brew /home/admin/homebrew \
    && eval "$(/home/admin/homebrew/bin/brew shellenv)" \
    && update --force --quiet \
    && chmod -R go-w "$(brew --prefix)/share/zsh" \
    && brew install fzf \
    && brew install thefuck \
    && brew install kubectl \
    && brew install kubectx 

USER root

### ðŸ‘‡ðŸ»oh my zsh å†…ç½®äº†shellä¸»é¢˜ï¼Œz å‘½ä»¤ï¼Œè‡ªåŠ¨è¡¥å…¨å’Œå„ç§å……æ»¡æƒ³è±¡åŠ›çš„å°ä¸œè¥¿
RUN echo y | bash -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)" \
    sed -i 's/plugins=(git)/plugins=(git z extract zsh-autosuggestions zsh-syntax-highlighting kubectl docker)/g' ~/.zshrc


### ðŸ‘‡ðŸ»å®‰è£…dockerçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸å®‰è£…daemon
# Install Docker CE CLI and docker-compose CLI ç¤¾åŒºç‰ˆçš„dockerè¿˜æ²¡å†…ç½®composeå‘½ä»¤ï¼Œè¿˜éœ€è¦é¢å¤–è£…ä¸ªdocker-compose
RUN apt-get update \
    && apt-get install -y apt-transport-https ca-certificates curl gnupg2 lsb-release \
    && curl -fsSL https://download.docker.com/linux/$(lsb_release -is | tr '[:upper:]' '[:lower:]')/gpg | apt-key add - 2>/dev/null \
    && echo "deb [arch=amd64] https://download.docker.com/linux/$(lsb_release -is | tr '[:upper:]' '[:lower:]') $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list \

    && apt-get install -y docker-ce-cli \
    && LATEST_COMPOSE_VERSION=$(curl -sSL "https://api.github.com/repos/docker/compose/releases/latest" | grep -o -P '(?<="tag_name": ").+(?=")') \
    && curl -sSL "https://github.com/docker/compose/releases/download/${LATEST_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose \
    && chmod +x /usr/local/bin/docker-compose

SHELL [ "zsh" ]